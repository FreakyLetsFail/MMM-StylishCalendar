<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MMM-StylishCalendar Setup</title>
  <style>
    :root {
      --theme-color: #ca5010;
      --theme-color-light: #eb7c42;
      --theme-color-dark: #9a3d0c;
      --bg-color: #121212;
      --surface-color: #1e1e1e;
      --text-color: #ffffff;
      --text-color-dimmed: #aaaaaa;
      --border-radius: 8px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px;
      background-color: var(--surface-color);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .logo {
      font-size: 1.8em;
      font-weight: bold;
      color: var(--theme-color);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .logo svg {
      width: 30px;
      height: 30px;
    }
    
    h1 {
      font-size: 1.8em;
      margin-bottom: 10px;
      color: var(--text-color);
    }
    
    h2 {
      font-size: 1.4em;
      margin: 30px 0 15px;
      color: var(--text-color);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 8px;
    }
    
    p {
      color: var(--text-color-dimmed);
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius);
      background-color: rgba(0, 0, 0, 0.2);
      color: var(--text-color);
      font-size: 1em;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--theme-color);
    }
    
    .auth-toggle {
      margin-top: 20px;
      background: none;
      border: none;
      color: var(--theme-color);
      font-size: 0.9em;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
    }
    
    .auth-fields {
      margin-top: 20px;
      padding: 15px;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: var(--border-radius);
      border-left: 3px solid var(--theme-color);
    }
    
    .button {
      background-color: var(--theme-color);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 1em;
      font-weight: 500;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .button:hover {
      background-color: var(--theme-color-light);
    }
    
    .button:active {
      background-color: var(--theme-color-dark);
    }
    
    .form-footer {
      margin-top: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .help-text {
      font-size: 0.9em;
      color: var(--text-color-dimmed);
    }
    
    .success-message, .error-message {
      padding: 15px;
      border-radius: var(--border-radius);
      margin-top: 20px;
      display: none;
    }
    
    .success-message {
      background-color: rgba(46, 204, 113, 0.2);
      border-left: 3px solid #2ecc71;
    }
    
    .error-message {
      background-color: rgba(231, 76, 60, 0.2);
      border-left: 3px solid #e74c3c;
    }
    
    .hidden {
      display: none;
    }
    
    .icon-preview {
      margin-top: 10px;
      color: var(--theme-color);
    }
    
    /* Tab navigation */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      margin-right: 10px;
      border-bottom: 3px solid transparent;
      color: var(--text-color-dimmed);
    }
    
    .tab.active {
      border-bottom-color: var(--theme-color);
      color: var(--text-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Calendar list styles */
    .calendar-list {
      margin-top: 30px;
    }
    
    .calendar-item {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: var(--border-radius);
      margin-bottom: 15px;
      padding: 15px;
      position: relative;
    }
    
    .calendar-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .calendar-item-title {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .calendar-item-category {
      font-size: 0.8em;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      text-transform: capitalize;
    }
    
    .calendar-item-url {
      font-size: 0.85em;
      color: var(--text-color-dimmed);
      word-break: break-all;
      margin: 10px 0;
      padding: 8px;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    
    .calendar-actions {
      display: flex;
      gap: 10px;
    }
    
    .action-button {
      background-color: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 0.85em;
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .action-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .action-button.edit {
      border-color: var(--theme-color-light);
      color: var(--theme-color-light);
    }
    
    .action-button.delete {
      border-color: #e74c3c;
      color: #e74c3c;
    }
    
    .action-button.edit:hover {
      background-color: rgba(202, 80, 16, 0.2);
    }
    
    .action-button.delete:hover {
      background-color: rgba(231, 76, 60, 0.2);
    }
    
    /* Edit form inside calendar item */
    .edit-form {
      display: none;
    }
    
    .calendar-item.editing .calendar-info {
      display: none;
    }
    
    .calendar-item.editing .edit-form {
      display: block;
    }
    
    .edit-form .form-footer {
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Entry count control styling */
    .entry-count-setting {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
    }
    
    .entry-count-setting label {
      margin-bottom: 0;
    }
    
    .entry-count-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .entry-count-control input {
      width: 70px;
      text-align: center;
    }
    
    .entry-count-control button {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background-color: var(--theme-color);
      color: white;
      font-size: 1.2em;
      cursor: pointer;
      border: none;
    }
    
    /* Loading indicators */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--theme-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Confirmation modal */
    .confirmation-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      display: none;
    }
    
    .modal-content {
      background-color: var(--surface-color);
      padding: 25px;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 400px;
    }
    
    .modal-title {
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    
    .modal-message {
      margin-bottom: 20px;
      color: var(--text-color-dimmed);
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M7,2H21C22.1,2 23,2.9 23,4V20C23,21.1 22.1,22 21,22H3C1.9,22 1,21.1 1,20V8L7,2M7,4V8H3V20H21V4H7M17,14H19V17H17V14M15,14H13V17H15V14M11,14H9V17H11V14M7,14H5V17H7V14Z"></path>
        </svg>
        MMM-StylishCalendar
      </div>
      <h1>Calendar Setup</h1>
      <p>Configure your calendar sources and appearance settings</p>
      
      <!-- Tab Navigation -->
      <div class="tabs">
        <div class="tab active" data-tab="add-calendar">Add Calendar</div>
        <div class="tab" data-tab="manage-calendars">Manage Calendars</div>
        <div class="tab" data-tab="settings">Settings</div>
      </div>
    </div>
    
    <!-- Add Calendar Tab -->
    <div id="add-calendar" class="tab-content active">
      <h2>Add New Calendar</h2>
      <p>Add a new calendar by entering its details below. Supports HTTP, HTTPS, and WebCal URLs.</p>
      
      <form id="calendar-form">
        <div class="form-group">
          <label for="calendar-name">Calendar Name</label>
          <input type="text" id="calendar-name" placeholder="My Calendar" required>
        </div>
        
        <div class="form-group">
          <label for="calendar-url">Calendar URL</label>
          <input type="text" id="calendar-url" placeholder="https://... or webcal://..." required>
          <small class="help-text">Supports webcal://, http://, and https:// protocols</small>
        </div>
        
        <div class="form-group">
          <label for="calendar-category">Category</label>
          <select id="calendar-category">
            <option value="default">Default</option>
            <option value="work">Work</option>
            <option value="family">Family</option>
            <option value="personal">Personal</option>
            <option value="holiday">Holiday</option>
            <option value="birthday">Birthday</option>
            <option value="travel">Travel</option>
            <option value="meeting">Meeting</option>
            <option value="custom">Custom...</option>
          </select>
        </div>
        
        <div class="form-group hidden" id="custom-category-group">
          <label for="custom-category">Custom Category Name</label>
          <input type="text" id="custom-category" placeholder="Enter category name">
        </div>
        
        <div class="form-group">
          <label for="calendar-symbol">Icon</label>
          <select id="calendar-symbol">
            <option value="calendar">Calendar</option>
            <option value="work">Work</option>
            <option value="family">Family</option>
            <option value="event">Event</option>
            <option value="birthday">Birthday</option>
            <option value="holiday">Holiday</option>
            <option value="travel">Travel</option>
            <option value="meeting">Meeting</option>
          </select>
          <div id="icon-preview" class="icon-preview">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M7,2H21C22.1,2 23,2.9 23,4V20C23,21.1 22.1,22 21,22H3C1.9,22 1,21.1 1,20V8L7,2M7,4V8H3V20H21V4H7M17,14H19V17H17V14M15,14H13V17H15V14M11,14H9V17H11V14M7,14H5V17H7V14Z"></path>
            </svg>
          </div>
        </div>
        
        <div class="form-group">
          <label for="calendar-color">Color</label>
          <input type="color" id="calendar-color" value="#ca5010">
        </div>
        
        <button type="button" id="auth-toggle" class="auth-toggle">+ Add authentication (if your calendar requires it)</button>
        
        <div id="auth-fields" class="auth-fields hidden">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" placeholder="your.email@example.com">
          </div>
          
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Your calendar password or app-specific password">
          </div>
        </div>
        
        <div class="form-footer">
          <p class="help-text">After adding a calendar, you may need to restart your MagicMirror</p>
          <button type="submit" class="button">Add Calendar</button>
        </div>
        
        <div class="success-message" id="success-message">
          Calendar added successfully! You can close this window or add another calendar.
        </div>
        
        <div class="error-message" id="error-message">
          There was an error adding your calendar. Please check your details and try again.
        </div>
      </form>
    </div>
    
    <!-- Manage Calendars Tab -->
    <div id="manage-calendars" class="tab-content">
      <h2>Manage Your Calendars</h2>
      <p>View, edit, or delete your calendar sources</p>
      
      <div id="calendar-list" class="calendar-list">
        <div id="loading-calendars" style="text-align: center; padding: 20px;">
          <div class="loading-spinner"></div>
          <p>Loading your calendars...</p>
        </div>
        
        <div id="no-calendars" class="hidden" style="text-align: center; padding: 20px;">
          No calendars found. Add one from the "Add Calendar" tab.
        </div>
      </div>
    </div>
    
    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
      <h2>Calendar Settings</h2>
      <p>Configure the display of your calendar</p>
      
      <div class="entry-count-setting">
        <label>Maximum number of entries to display</label>
        <div class="entry-count-control">
          <button type="button" id="decrease-entries">-</button>
          <input type="number" id="max-entries" min="1" max="50" value="10">
          <button type="button" id="increase-entries">+</button>
        </div>
      </div>
      <p class="help-text">Configure how many entries to show in total, instead of limiting by days.</p>
      
      <div class="form-footer">
        <button type="button" id="save-settings" class="button">Save Settings</button>
      </div>
      
      <div class="success-message" id="settings-success-message">
        Settings saved successfully!
      </div>
      
      <div class="error-message" id="settings-error-message">
        There was an error saving your settings. Please try again.
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div class="confirmation-modal" id="delete-modal">
    <div class="modal-content">
      <div class="modal-title">Delete Calendar</div>
      <div class="modal-message">Are you sure you want to delete this calendar? This action cannot be undone.</div>
      <div class="modal-actions">
        <button class="action-button" id="cancel-delete">Cancel</button>
        <button class="action-button delete" id="confirm-delete">Delete</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const instanceId = urlParams.get('instance') || Date.now().toString(16);
      
      // DOM Elements
      const authToggle = document.getElementById('auth-toggle');
      const authFields = document.getElementById('auth-fields');
      const form = document.getElementById('calendar-form');
      const successMessage = document.getElementById('success-message');
      const errorMessage = document.getElementById('error-message');
      const categorySelect = document.getElementById('calendar-category');
      const customCategoryGroup = document.getElementById('custom-category-group');
      const symbolSelect = document.getElementById('calendar-symbol');
      const iconPreview = document.getElementById('icon-preview');
      const calendarList = document.getElementById('calendar-list');
      const loadingCalendars = document.getElementById('loading-calendars');
      const noCalendars = document.getElementById('no-calendars');
      const maxEntries = document.getElementById('max-entries');
      const decreaseEntries = document.getElementById('decrease-entries');
      const increaseEntries = document.getElementById('increase-entries');
      const saveSettings = document.getElementById('save-settings');
      const settingsSuccessMessage = document.getElementById('settings-success-message');
      const settingsErrorMessage = document.getElementById('settings-error-message');
      const deleteModal = document.getElementById('delete-modal');
      const cancelDelete = document.getElementById('cancel-delete');
      const confirmDelete = document.getElementById('confirm-delete');
      
      // Tabs functionality
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      // SVG icon paths for preview
      const iconPaths = {
        calendar: "M7,2H21C22.1,2 23,2.9 23,4V20C23,21.1 22.1,22 21,22H3C1.9,22 1,21.1 1,20V8L7,2M7,4V8H3V20H21V4H7M17,14H19V17H17V14M15,14H13V17H15V14M11,14H9V17H11V14M7,14H5V17H7V14Z",
        work: "M10,2H14A2,2 0 0,1 16,4V6H20A2,2 0 0,1 22,8V19A2,2 0 0,1 20,21H4C2.89,21 2,20.1 2,19V8C2,6.89 2.89,6 4,6H8V4C8,2.89 8.89,2 10,2M14,6V4H10V6H14Z",
        family: "M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z",
        event: "M16,13C15.71,13 15.38,13.03 15.03,13.05C16.19,13.89 17,15 17,16.5V19H23V16.5C23,14.17 18.33,13 16,13M8,13C5.67,13 1,14.17 1,16.5V19H15V16.5C15,14.17 10.33,13 8,13M8,11A3,3 0 0,0 11,8A3,3 0 0,0 8,5A3,3 0 0,0 5,8A3,3 0 0,0 8,11M16,11A3,3 0 0,0 19,8A3,3 0 0,0 16,5A3,3 0 0,0 13,8A3,3 0 0,0 16,11Z",
        birthday: "M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z",
        holiday: "M8,17.85C8,19.04 7.11,20 6,20C4.89,20 4,19.04 4,17.85C4,16.42 6,14 6,14C6,14 8,16.42 8,17.85M16.46,12V10.54L8.46,5.54L7.04,7.46L13.54,11.46H3V13.46H13.54L7.04,17.46L8.46,19.38L16.46,14.38V12.92L18.04,14V10L16.46,12Z",
        travel: "M2.5,19H21.5V21H2.5V19M22.07,9.64C21.86,8.84 21.03,8.36 20.23,8.58L14.92,10L8,7.67L3.8,9.35L5.8,13.13L8.97,12.11L10.93,12.95L2.45,16.16L3.22,18.08L13.47,14.13L17.5,18.35L19,17.66L15.56,12.26L20.5,10.95C21.3,10.74 21.77,9.9 21.56,9.11L22.07,9.64Z",
        meeting: "M17,12V3A1,1 0 0,0 16,2H3A1,1 0 0,0 2,3V17L6,13H16A1,1 0 0,0 17,12M21,6H19V15H6V17A1,1 0 0,0 7,18H18L22,22V7A1,1 0 0,0 21,6Z"
      };
      
      // Variable to store current calendar being deleted
      let currentDeleteUrl = null;
      
      // Settings
      let settings = {
        maximumEntries: 10
      };
      
      // Show custom category field when custom is selected
      categorySelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          customCategoryGroup.classList.remove('hidden');
        } else {
          customCategoryGroup.classList.add('hidden');
        }
      });
      
      // Update icon preview when changing selection
      symbolSelect.addEventListener('change', function() {
        const iconPath = iconPaths[this.value] || iconPaths.calendar;
        iconPreview.innerHTML = `
          <svg viewBox="0 0 24 24" width="24" height="24">
            <path fill="currentColor" d="${iconPath}"></path>
          </svg>
        `;
      });
      
      // Toggle authentication fields
      authToggle.addEventListener('click', function() {
        authFields.classList.toggle('hidden');
        authToggle.textContent = authFields.classList.contains('hidden') 
          ? '+ Add authentication (if your calendar requires it)'
          : '- Hide authentication options';
      });
      
      // Tab switching functionality
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // If clicking on manage calendars tab, load calendars
          if (this.dataset.tab === 'manage-calendars') {
            loadCalendars();
          }
          
          // Toggle active class on tabs
          tabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Show corresponding tab content
          tabContents.forEach(content => content.classList.remove('active'));
          document.getElementById(this.dataset.tab).classList.add('active');
        });
      });
      
      // Entry count controls
      decreaseEntries.addEventListener('click', function() {
        const currentValue = parseInt(maxEntries.value);
        if (currentValue > 1) {
          maxEntries.value = currentValue - 1;
        }
      });
      
      increaseEntries.addEventListener('click', function() {
        const currentValue = parseInt(maxEntries.value);
        if (currentValue < 50) {
          maxEntries.value = currentValue + 1;
        }
      });
      
      // Save settings
      saveSettings.addEventListener('click', function() {
        settings.maximumEntries = parseInt(maxEntries.value);
        
        // Save settings via API here
        fetch(`/api/settings/${instanceId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            maximumEntries: settings.maximumEntries
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            settingsSuccessMessage.style.display = 'block';
            
            // Hide success message after 3 seconds
            setTimeout(() => {
              settingsSuccessMessage.style.display = 'none';
            }, 3000);
          } else {
            settingsErrorMessage.textContent = data.error || 'Unknown error occurred.';
            settingsErrorMessage.style.display = 'block';
          }
        })
        .catch(error => {
          console.error('Error saving settings:', error);
          settingsErrorMessage.textContent = 'Connection error. Please try again later.';
          settingsErrorMessage.style.display = 'block';
        });
      });
      
      // Delete calendar confirmation
      cancelDelete.addEventListener('click', function() {
        deleteModal.style.display = 'none';
        currentDeleteUrl = null;
      });
      
      confirmDelete.addEventListener('click', function() {
        if (currentDeleteUrl) {
          deleteCalendar(currentDeleteUrl);
        }
        deleteModal.style.display = 'none';
      });
      
      // Form submission for adding calendar
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const calendarName = document.getElementById('calendar-name').value;
        const calendarUrl = document.getElementById('calendar-url').value;
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const calendarCategory = document.getElementById('calendar-category').value;
        const customCategory = document.getElementById('custom-category').value;
        const calendarSymbol = document.getElementById('calendar-symbol').value;
        const calendarColor = document.getElementById('calendar-color').value;
        
        // Determine final category value
        const finalCategory = calendarCategory === 'custom' ? customCategory : calendarCategory;
        
        // Prepare data
        const data = {
          name: calendarName,
          url: calendarUrl,
          category: finalCategory,
          symbol: calendarSymbol,
          color: calendarColor
        };
        
        // Add authentication if provided
        if (username && password) {
          data.auth = {
            method: "basic",
            user: username,
            pass: password
          };
        }
        
        // Send to API
        fetch(`/api/calendars/${instanceId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success message
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            
            // Reset form
            form.reset();
            authFields.classList.add('hidden');
            customCategoryGroup.classList.add('hidden');
            authToggle.textContent = '+ Add authentication (if your calendar requires it)';
            
            // Reset icon preview
            iconPreview.innerHTML = `
              <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="${iconPaths.calendar}"></path>
              </svg>
            `;
            
            // Hide success message after 5 seconds
            setTimeout(() => {
              successMessage.style.display = 'none';
            }, 5000);
          } else {
            // Show error message
            errorMessage.textContent = data.error || 'There was an error adding your calendar. Please check your details and try again.';
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
          }
        })
        .catch(error => {
          // Show error message
          errorMessage.textContent = 'Connection error. Please try again later.';
          errorMessage.style.display = 'block';
          successMessage.style.display = 'none';
          console.error('Error:', error);
        });
      });
      
      // Load calendars from API
      function loadCalendars() {
        loadingCalendars.style.display = 'block';
        noCalendars.classList.add('hidden');
        
        // Clear existing calendar items (except loading and no-calendar messages)
        const items = calendarList.querySelectorAll('.calendar-item');
        items.forEach(item => item.remove());
        
        fetch(`/api/calendars/${instanceId}`)
          .then(response => response.json())
          .then(data => {
            loadingCalendars.style.display = 'none';
            
            if (data.success && data.calendars && data.calendars.length > 0) {
              data.calendars.forEach(calendar => {
                calendarList.appendChild(createCalendarItem(calendar));
              });
            } else {
              noCalendars.classList.remove('hidden');
            }
          })
          .catch(error => {
            loadingCalendars.style.display = 'none';
            noCalendars.classList.remove('hidden');
            noCalendars.textContent = 'Error loading calendars. Please try again later.';
            console.error('Error loading calendars:', error);
          });
      }
      
      // Create calendar list item
      function createCalendarItem(calendar) {
        const item = document.createElement('div');
        item.className = 'calendar-item';
        item.dataset.url = calendar.url;
        
        // Create main info section
        const info = document.createElement('div');
        info.className = 'calendar-info';
        
        // Create header
        const header = document.createElement('div');
        header.className = 'calendar-item-header';
        
        // Create title with icon
        const title = document.createElement('div');
        title.className = 'calendar-item-title';
        
        // Add icon
        const icon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        icon.setAttribute("viewBox", "0 0 24 24");
        icon.setAttribute("width", "20");
        icon.setAttribute("height", "20");
        
        const iconPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        iconPath.setAttribute("d", iconPaths[calendar.symbol] || iconPaths.calendar);
        iconPath.setAttribute("fill", calendar.color);
        
        icon.appendChild(iconPath);
        title.appendChild(icon);
        
        // Add name
        const nameSpan = document.createElement('span');
        nameSpan.textContent = calendar.name;
        title.appendChild(nameSpan);
        
        // Create category badge
        const category = document.createElement('div');
        category.className = 'calendar-item-category';
        category.textContent = calendar.category;
        
        // Add actions
        const actions = document.createElement('div');
        actions.className = 'calendar-actions';
        
        const editButton = document.createElement('button');
        editButton.className = 'action-button edit';
        editButton.textContent = 'Edit';
        editButton.addEventListener('click', function() {
          // Toggle editing mode
          item.classList.toggle('editing');
          
          // If entering edit mode, populate the form
          if (item.classList.contains('editing')) {
            const editForm = item.querySelector('.edit-form');
            const nameInput = editForm.querySelector('[name="edit-name"]');
            const categorySelect = editForm.querySelector('[name="edit-category"]');
            const symbolSelect = editForm.querySelector('[name="edit-symbol"]');
            const colorInput = editForm.querySelector('[name="edit-color"]');
            
            nameInput.value = calendar.name;
            categorySelect.value = calendar.category;
            symbolSelect.value = calendar.symbol || 'calendar';
            colorInput.value = calendar.color || '#ca5010';
          }
        });
        
        const deleteButton = document.createElement('button');
        deleteButton.className = 'action-button delete';
        deleteButton.textContent = 'Delete';
        deleteButton.addEventListener('click', function() {
          // Show confirmation modal
          currentDeleteUrl = calendar.url;
          deleteModal.style.display = 'flex';
        });
        
        actions.appendChild(editButton);
        actions.appendChild(deleteButton);
        
        // Add to header
        header.appendChild(title);
        header.appendChild(actions);
        
        // Create URL display
        const urlDisplay = document.createElement('div');
        urlDisplay.className = 'calendar-item-url';
        urlDisplay.textContent = calendar.url;
        
        // Add elements to info section
        info.appendChild(header);
        info.appendChild(category);
        info.appendChild(urlDisplay);
        
        // Create edit form
        const editForm = document.createElement('div');
        editForm.className = 'edit-form';
        editForm.innerHTML = `
          <div class="form-group">
            <label>Calendar Name</label>
            <input type="text" name="edit-name" value="${calendar.name}" required>
          </div>
          
          <div class="form-group">
            <label>Category</label>
            <select name="edit-category">
              <option value="default" ${calendar.category === 'default' ? 'selected' : ''}>Default</option>
              <option value="work" ${calendar.category === 'work' ? 'selected' : ''}>Work</option>
              <option value="family" ${calendar.category === 'family' ? 'selected' : ''}>Family</option>
              <option value="personal" ${calendar.category === 'personal' ? 'selected' : ''}>Personal</option>
              <option value="holiday" ${calendar.category === 'holiday' ? 'selected' : ''}>Holiday</option>
              <option value="birthday" ${calendar.category === 'birthday' ? 'selected' : ''}>Birthday</option>
              <option value="travel" ${calendar.category === 'travel' ? 'selected' : ''}>Travel</option>
              <option value="meeting" ${calendar.category === 'meeting' ? 'selected' : ''}>Meeting</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Icon</label>
            <select name="edit-symbol">
              <option value="calendar" ${(calendar.symbol === 'calendar' || !calendar.symbol) ? 'selected' : ''}>Calendar</option>
              <option value="work" ${calendar.symbol === 'work' ? 'selected' : ''}>Work</option>
              <option value="family" ${calendar.symbol === 'family' ? 'selected' : ''}>Family</option>
              <option value="event" ${calendar.symbol === 'event' ? 'selected' : ''}>Event</option>
              <option value="birthday" ${calendar.symbol === 'birthday' ? 'selected' : ''}>Birthday</option>
              <option value="holiday" ${calendar.symbol === 'holiday' ? 'selected' : ''}>Holiday</option>
              <option value="travel" ${calendar.symbol === 'travel' ? 'selected' : ''}>Travel</option>
              <option value="meeting" ${calendar.symbol === 'meeting' ? 'selected' : ''}>Meeting</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Color</label>
            <input type="color" name="edit-color" value="${calendar.color || '#ca5010'}">
          </div>
          
          <div class="form-footer">
            <button type="button" class="action-button" data-action="cancel">Cancel</button>
            <button type="button" class="button" data-action="save">Save Changes</button>
          </div>
        `;
        
        // Add event listeners to the form buttons
        editForm.querySelector('[data-action="cancel"]').addEventListener('click', function() {
          item.classList.remove('editing');
        });
        
        editForm.querySelector('[data-action="save"]').addEventListener('click', function() {
          const nameInput = editForm.querySelector('[name="edit-name"]');
          const categorySelect = editForm.querySelector('[name="edit-category"]');
          const symbolSelect = editForm.querySelector('[name="edit-symbol"]');
          const colorInput = editForm.querySelector('[name="edit-color"]');
          
          const updatedData = {
            url: calendar.url,
            name: nameInput.value,
            category: categorySelect.value,
            symbol: symbolSelect.value,
            color: colorInput.value
          };
          
          // Add authentication if it exists in the original
          if (calendar.auth) {
            updatedData.auth = calendar.auth;
          }
          
          // Send update request
          updateCalendar(updatedData, item);
        });
        
        // Add all elements to the item
        item.appendChild(info);
        item.appendChild(editForm);
        
        return item;
      }
      
      // Delete calendar function
      function deleteCalendar(url) {
        const encodedUrl = encodeURIComponent(url);
        
        fetch(`/api/calendars/${instanceId}/${encodedUrl}`, {
          method: 'DELETE'
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Remove from UI
              const item = calendarList.querySelector(`.calendar-item[data-url="${url}"]`);
              if (item) {
                item.remove();
              }
              
              // Check if no calendars left
              if (calendarList.querySelectorAll('.calendar-item').length === 0) {
                noCalendars.classList.remove('hidden');
              }
            } else {
              alert('Error deleting calendar: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('Error deleting calendar:', error);
            alert('Connection error. Please try again later.');
          });
      }
      
      // Update calendar function
      function updateCalendar(calendarData, itemElement) {
        fetch(`/api/calendars/${instanceId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(calendarData)
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Exit edit mode
              itemElement.classList.remove('editing');
              
              // Reload calendars to show updated data
              loadCalendars();
            } else {
              alert('Error updating calendar: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('Error updating calendar:', error);
            alert('Connection error. Please try again later.');
          });
      }
      
      // Initialize by loading settings
      fetch(`/api/settings/${instanceId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.settings) {
            settings = data.settings;
            maxEntries.value = settings.maximumEntries || 10;
          }
        })
        .catch(error => {
          console.error('Error loading settings:', error);
        });
    });
  </script>
</body>
</html>